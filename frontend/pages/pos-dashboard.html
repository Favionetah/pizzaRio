<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS - Pizza Rio</title>
    <script src="https://unpkg.com/vue@3"></script>
    <link rel="stylesheet" href="../public/css/main.css">
</head>
<body>
    <div id="app">
        <div class="page-wrapper">
            <header class="header">
                <div class="header-content">
                    <div class="logo">üçï Pizza Rio - POS</div>
                    <div class="user-info">
                        <span>{{ user ? user.name : '' }} ({{ user ? user.role : '' }})</span>
                        <button @click="logout" class="btn btn-sm btn-outline" style="color: white; border-color: white;">Salir</button>
                    </div>
                </div>
            </header>

            <nav class="nav">
                <ul class="nav-list">
                    <li class="nav-item"><a href="#" @click.prevent="currentView='orders'" :class="{active: currentView==='orders'}">Pedidos</a></li>
                    <li class="nav-item" v-if="isAdmin"><a href="#" @click.prevent="currentView='products'" :class="{active: currentView==='products'}">Productos</a></li>
                    <li class="nav-item" v-if="isAdmin"><a href="#" @click.prevent="currentView='users'" :class="{active: currentView==='users'}">Usuarios</a></li>
                </ul>
            </nav>

            <main class="container" style="margin-top: 20px;">
                <!-- Vista de Pedidos -->
                <div v-if="currentView === 'orders'">
                    <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h1>Gesti√≥n de Pedidos</h1>
                        <button @click="loadOrders" class="btn btn-secondary">Actualizar</button>
                    </div>

                    <div class="tabs">
                        <button class="tab" :class="{active: orderFilter==='all'}" @click="orderFilter='all'">Todos</button>
                        <button class="tab" :class="{active: orderFilter==='PENDING'}" @click="orderFilter='PENDING'">Pendientes</button>
                        <button class="tab" :class="{active: orderFilter==='PREPARING'}" @click="orderFilter='PREPARING'">Preparando</button>
                        <button class="tab" :class="{active: orderFilter==='READY'}" @click="orderFilter='READY'">Listos</button>
                    </div>

                    <div v-if="loadingOrders" class="text-center" style="padding: 40px;">
                        <div class="loading"></div>
                    </div>
                    <div v-else-if="filteredOrders.length === 0" class="card text-center">
                        <p>No hay pedidos</p>
                    </div>
                    <div v-else class="grid grid-2">
                        <div v-for="order in filteredOrders" :key="order.id" class="card">
                            <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3>Pedido #{{ order.id }}</h3>
                                <span class="badge" :class="getBadgeClass(order.status)">{{ getStatusText(order.status) }}</span>
                            </div>
                            <p><strong>Cliente:</strong> {{ order.user_name || order.guest_name }}</p>
                            <p><strong>Tel√©fono:</strong> {{ order.guest_phone || 'N/A' }}</p>
                            <p><strong>Tipo:</strong> {{ order.order_type === 'EAT_IN' ? 'Para comer aqu√≠' : 'Para llevar' }}</p>
                            <p><strong>Hora:</strong> {{ formatTime(order.created_at) }}</p>
                            <p><strong>Total:</strong> ${{ parseFloat(order.total_amount).toFixed(2) }}</p>
                            
                            <div style="margin-top: 10px; margin-bottom: 10px;">
                                <strong>Productos:</strong>
                                <ul style="margin-left: 20px; margin-top: 5px;">
                                    <li v-for="item in order.items" :key="item.id">
                                        {{ item.product_name }} x{{ item.quantity }}
                                    </li>
                                </ul>
                            </div>

                            <div class="flex gap-1" style="margin-top: 10px;">
                                <button v-if="order.status === 'PENDING'" @click="updateOrderStatus(order.id, 'PREPARING')" class="btn btn-sm btn-secondary">Preparar</button>
                                <button v-if="order.status === 'PREPARING'" @click="updateOrderStatus(order.id, 'READY')" class="btn btn-sm btn-success">Marcar Listo</button>
                                <button v-if="order.status === 'READY'" @click="updateOrderStatus(order.id, 'COMPLETED')" class="btn btn-sm btn-success">Completar</button>
                                <button v-if="order.status !== 'CANCELLED' && order.status !== 'COMPLETED'" @click="updateOrderStatus(order.id, 'CANCELLED')" class="btn btn-sm btn-danger">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vista de Productos -->
                <div v-if="currentView === 'products' && isAdmin">
                    <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h1>Gesti√≥n de Productos</h1>
                        <button @click="openProductModal()" class="btn btn-primary">Nuevo Producto</button>
                    </div>

                    <div v-if="loadingProducts" class="text-center" style="padding: 40px;">
                        <div class="loading"></div>
                    </div>
                    <div v-else>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Categor√≠a</th>
                                    <th>Precio</th>
                                    <th>Disponible</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="product in products" :key="product.id">
                                    <td>{{ product.id }}</td>
                                    <td>{{ product.name }}</td>
                                    <td>{{ getCategoryText(product.category) }}</td>
                                    <td>${{ parseFloat(product.price).toFixed(2) }}</td>
                                    <td>{{ product.available ? 'S√≠' : 'No' }}</td>
                                    <td>
                                        <button @click="openProductModal(product)" class="btn btn-sm btn-secondary">Editar</button>
                                        <button @click="deleteProductConfirm(product)" class="btn btn-sm btn-danger">Eliminar</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Vista de Usuarios -->
                <div v-if="currentView === 'users' && isAdmin">
                    <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h1>Gesti√≥n de Usuarios</h1>
                        <button @click="openUserModal()" class="btn btn-primary">Nuevo Usuario</button>
                    </div>

                    <div v-if="loadingUsers" class="text-center" style="padding: 40px;">
                        <div class="loading"></div>
                    </div>
                    <div v-else>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Usuario</th>
                                    <th>Nombre</th>
                                    <th>Rol</th>
                                    <th>Tel√©fono</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="usr in users" :key="usr.id">
                                    <td>{{ usr.id }}</td>
                                    <td>{{ usr.username }}</td>
                                    <td>{{ usr.name }}</td>
                                    <td>{{ usr.role }}</td>
                                    <td>{{ usr.phone || 'N/A' }}</td>
                                    <td>
                                        <button @click="openUserModal(usr)" class="btn btn-sm btn-secondary">Editar</button>
                                        <button @click="deleteUserConfirm(usr)" class="btn btn-sm btn-danger">Eliminar</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>

        <!-- Modal de Producto -->
        <div class="modal" :class="{active: showProductModal}" @click.self="closeProductModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>{{ editingProduct ? 'Editar Producto' : 'Nuevo Producto' }}</h2>
                    <button class="modal-close" @click="closeProductModal">‚úï</button>
                </div>

                <form @submit.prevent="saveProduct">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input v-model="productForm.name" type="text" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n</label>
                        <input v-model="productForm.description" type="text" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a</label>
                        <select v-model="productForm.category" class="form-control" required>
                            <option value="PIZZA">Pizza</option>
                            <option value="DRINK">Bebida</option>
                            <option value="DESSERT">Postre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Precio</label>
                        <input v-model.number="productForm.price" type="number" step="0.01" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>
                            <input v-model="productForm.available" type="checkbox">
                            Disponible
                        </label>
                    </div>

                    <div v-if="productMessage" :class="'alert alert-' + productMessageType">
                        {{ productMessage }}
                    </div>

                    <div class="flex gap-1">
                        <button type="submit" class="btn btn-primary" :disabled="savingProduct">
                            {{ savingProduct ? 'Guardando...' : 'Guardar' }}
                        </button>
                        <button type="button" @click="closeProductModal" class="btn btn-outline">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal de Usuario -->
        <div class="modal" :class="{active: showUserModal}" @click.self="closeUserModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>{{ editingUser ? 'Editar Usuario' : 'Nuevo Usuario' }}</h2>
                    <button class="modal-close" @click="closeUserModal">‚úï</button>
                </div>

                <form @submit.prevent="saveUser">
                    <div class="form-group">
                        <label>Usuario</label>
                        <input v-model="userForm.username" type="text" class="form-control" required :disabled="editingUser">
                    </div>
                    <div class="form-group">
                        <label>Nombre</label>
                        <input v-model="userForm.name" type="text" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input v-model="userForm.phone" type="tel" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Rol</label>
                        <select v-model="userForm.role" class="form-control" required>
                            <option value="CLIENT">Cliente</option>
                            <option value="CASHIER">Cajero</option>
                            <option value="ADMIN">Administrador</option>
                        </select>
                    </div>
                    <div class="form-group" v-if="!editingUser">
                        <label>Contrase√±a</label>
                        <input v-model="userForm.password" type="password" class="form-control" required minlength="6">
                    </div>

                    <div v-if="userMessage" :class="'alert alert-' + userMessageType">
                        {{ userMessage }}
                    </div>

                    <div class="flex gap-1">
                        <button type="submit" class="btn btn-primary" :disabled="savingUser">
                            {{ savingUser ? 'Guardando...' : 'Guardar' }}
                        </button>
                        <button type="button" @click="closeUserModal" class="btn btn-outline">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../public/js/api.js"></script>
    <script src="../js/pos.js"></script>
</body>
</html>
